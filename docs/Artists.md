Artists and Bios
================

## Models

### `Bio`

The `Bio` model holds all the artist data that's been extracted from an online artist biography. Typically these are generated by scrapers in `ukiyoe-scrapers`.

**Properties:**

* `name`: The name of the artist, in the form of a `Name` object.
* `aliases`: An array of alternate names of the artist, also all in the form of a `Name` object.
* `bio`: A string bio for the artist.
* `active`: A date range representing the years in which an artist was active. In the form of a `YearRange` object.
* `life`: A date range representing the years in which an artist was alive. In the form of a `YearRange` object.
* `gender`: A string representing the gender of the artist.
* `locations`: An array holding the locations in which the artist was active.
* `url`: Full URL of the original page from where the image came.
* `viafURL`: The location of the matching VIAF record for this bio. Only some sources are capable of providing VIAF URLs (namely the NDLNA). VIAF URLs are useful as it can give us a canonical record to link back to (and merge with other compatible databases).
* `source`: The ID of the source from whence the bio came.
* `artist`: The ID of the `Artist` record that this `Bio` record was upgraded to.
* `similar`: An array of `Bio` IDs that were generated during the merging process (e.g. two bios were determined to be the same artist, they are then added to each other's `similar` list).
* `lang`: The language of the page from where the data is being extracted. This will influence how extracted text is handled.

**Instance Methods:**

* `matches`: Does this `Bio` record match another `Bio` record - and how strongly? Returns `0` for no match, `1` for a weak match, and `2` for a strong match. This is done by comparing the name (see `nameMatches`), aliases (see `aliasMatches`) and dates (see `dateMatches`) associated with the bios.
* `potentialArtists`: Using the bio details, do a search against pre-existing `Artist` records and come up with a list of similar artists. These results are not filtered and may contain many spurious results.
* `findMatches`: Go through a list of `Artist` records and find ones that are the best possible match to this bio (using `matches`). Returns an object with two properties: `possible` (an array of possible artist matches) and `match` (an object holding a strong artist match). If there is a result in `match` then that should be a direct match for the bio, if there is none then you should fall back to the results in `possible`.
* `addToArtist`: Add this `Bio` record to an `Artist` record. Mostly done by calling `addBio` on the corresponding `Artist` record.

**Static Methods:**

* `mergeBios`: Go through a set of bios, filtered by source, and attempts to merge them into an `Artist` record. Uses `potentialArtists` and `findMatches` to find, and filter, sets of artists for a bio. If an exact match, or no match, is found then the bio is immediately added to an artist (or a new artist record is created). If there are ambiguous results then a callback is run and the user must provide some additional input to aide in the selection process. See `utils/merge-bios.js` for an example of how this would be used.

### `Artist`

The `Artist` model is very similar to the `Bio` model, holding nearly all of the same properties, but it has a few additions.

**Properties:**

* `slug`: The slug to use in the URL for this artist. Note: May not be needed, we can probably generate this dynamically.
* `oldSlugs`: These are slugs from the old site that we need to redirect to this artist record.
* `repImage`: An `Image` ID that points to a representative print image for the artist (right now this is used for the artist list on the home page).
* `eras`: An array of `Era` IDs that represent the time periods in which the artist was active. This was manually populated and is ported over from the old site. Should probably be generated automatically based upon the years in which the artist was active.
* `printCount`: The number of print images that the artist has associated with it. This is currently populated on initial load of the server.
* `activeAlt`/`lifeAlt`: Arrays of date ranges in which an artist was active or lived. This is in addition to the the `active` and `life` properties. These are populated when a bio is merged in but the `active` or `life` properties conflict with those already set on the artist. The alternate date range is then added to this alternate list for future display. 
* `artistImage`: An `Image` ID of a print that depicts the artist in question (we don't currently populate this).
* `matchedStrings`: Many of the utilities listed below require user intervention for matching an artist. Every time this happens we add the string that was used to match to the `matchedStrings` property. This makes it so that future lookups can be done instantly and without user intervention.

**Instance Methods:**

* `addBio`: Add a `Bio` record into an `Artist` record. This is done by calling `mergeName` and `mergeDates` on the corresponding `Bio` properties.
* `mergeName`: Merge missing name details from a `Bio` into this `Artist` record. For example if the `Bio` has a family name and this `Artist` record doesn't have one, then the family name will be added to this artist's name. Look at `tests/bio/match_test.js` for tests for this and `mergeDates`.
* `mergeDates`: Fill in missing dates from a `Bio` record. For example if the `Artist` record had a life range of ` - 1875` and the range of `1840 - 1875` was being merged in then the start of the range would be added.
* `mergeArtist`: Merge another `Artist` record into this `Artist` record. Should probably be flushed out - if we were going to do this for real then we'd need to remove all references from the old `Artist` record.
* `rebuild`: Reconstruct an `Artist` record from the `Bio`s associated with it (re-building the names and dates from the bios). This would be useful if you have updated bios and which to update the details in the `Artist` record, as well. 

**Static Methods:**

* `searchByName`:

Document:
- romaji-name, et. al.

## Workflow

The general workflow for generating all the new `Artist` records and full `Image` records is as follows:

Generate `Bio` records:

* Scrape bios using `ukiyoe-scrapers` (DONE)
* Run `ndlna-bio-gen.js` (DONE)

Turn `Bio`s into `Artist` records:

* Run `merge-bios.js` (IN PROGRESS)

Create relationship between old artist pages and the new ones:

* Run `map-artist-slugs.js`

Import old image entries and create `ExtractedImage` records:

* Run `import-old-site.js`

Upgrade `ExtractedImage` records into full `Image` records:

* Run `upgrade-extracted.js`

## Utilities

### `utils/merge-bios.js`

**What does this do:** This script merges a set of bios (previously scraped by the bio scrapers in `ukiyoe-scrapers`) into pre-existing artist models.

**When is it used:** This is used every time a new bio source is added into the site. Ideally this will all be done up front and likely will only be done once (and certainly once per source).

**How to use it:** Run: `node utils/merge-bios.js SOURCE` You'll need to pull from one of the bio sources.

**Status:** Done: ndlna, bm. In Progress: yoshio. Todo: artelino, floating, ja-wikipedia, japanesegallery, myjapanesehanga, osaka, robyn, ukiyo-e, wikipedia.

**How does it work:**

Merges artist biographies into a single Artist record. If no artist record exists a new one is created. If it's not clear which artist record the bio belongs to then you will be prompted for further clarification.

The script works in two phases: First it attempts to find any viable artist records to merge the bio in to. After finding some records it then attempts to merge the bio into a pre-existing record.

Finding similar artists.

- Search by artist name/date details in Elasticsearch.
- Filter out any artists that don't match a basic set of criteria (such as a partial name match, for both the primary name or for the aliases).
- Determine if there's an exact match.
- If no exact match, defer to the user to provide input.
- If no match, at all, is found: create a new artist record, populated by this bio.

How a bio merge works. If an exact match for a bio was found, or if the user (after input), provides clarification as to which artist the bio should be merged in to, then the bio is merged in to the artist record.

- Attempt to fill in any missing details about the artist.
  - Fill in name details (esp. kanji)
  - Fill in active/life dates
    - If there is a conflict add to `alt_` fields.

### `utils/ndlna-bio-gen.js`

Generates NDLNA bios (must be generated, not directly scraped).

### `utils/map-artist-slugs.js`

**What does this do:** This script maps artist slugs from the old site to artist models in the new site.

**When is it used:** After all (or enough) of the bios have been imported in order to match most (if not all of) the old slugs. This script is only run once and during the process of setting up the new site.

**How does it work:**

On the new site the URLs for artist pages is different from how they use to be. Namely they now contain an ID in the URL, in addition to the artist name slug.

For example previously the page for Hiroshige was:

`/artists/utagawa-hiroshige`

and now it's something like:

`/artists/utagawa-hiroshige/535e864e4e4ee5000063be12`

Note that the actual slug is ignored, only the ID of the artist is used. Now the problem is that we need to redirect the old slugs to the new pages (and make sure that those new pages are, in fact, referring to the same artist).

The `utils/map-artist-slugs.js` script manages the process of mapping these slugs over to the new Artist models. This process is completed in a few steps:

- We collect all the artist entries from the old site (the processed version of these were stored in `data/names-ready.json`).
- We iterate through all the old entries and look for entries that we haven't already processed.
- If we haven't processed the artist entry before then we convert the available name data (their English and Kanji forms of the name) and convert it into a usable name object (using the `romaji-name` module).
- We then build a fake Bio object and add this new name object onto it. We do this as it makes it easy to search for potential Artist models that match this "bio" (using the `potentialArtists` method on the Bio model).
- If we find an exact match for the old artist entry then we add the old slug to the Artist model (in the `oldSlugs` field).
- If no exact match is found (but some potential matches are) then we need to prompt the user for input in figuring out which artist model best matches the one we're looking for.
- If no exact or in-exact match is found then we print out an error. This is bad, and hopefully shouldn't happen, as those artist URLs will no longer have a match on the new site! It's not the end of the world though as in these cases we'll do a simple redirect of: `/artists/joe-smith` to: `/search?q=joe+smith`, so at least the user will get something useful.

### `utils/import-highlights.js`

### `utils/set-artist-slugs.js`

**What does this do:** This script sets the preferred slug for every artist.

NOTE: May not be needed any more as we now use IDs as the primary lookup mechanism, not the slug (which is just a nicety, mostly to help SEO).

Instead we should probably just set the slug when the artist name is set (or updated). Handle this in `merge-bios.js`.

### `utils/ambiguous-artists.js`

TO IMPLEMENT

Look for artists that are potentially in conflict (in that they directly match each other). For example if there are two Katsushika Hokusais. If there is one artist which is unquestionably the more popular one, possibly delete the name from the other artist. If that's the artist's only name then the artist should just be deleted.

This should probably be run after every merging of bios - or maybe even be just integrated into the merge bio process.

### `utils/import-old-site.js`

**What does this do:** Takes image data from the old version of the site (the raw image `.json` files) and creates new `ExtractedImage` records for them.

**When is it used:** This is run once, for each image `.json` file.

### `utils/upgrade-extracted.js`

**What does this do:** Upgrade some images that've been scraped and extracted from a site into a full image (`ExtractedImage -> Image`). As a part of this the image is associated with a particular artist (if possible).

**When is it used:** After all the `Artist` records have been generated, this is done on a source-by-source basis. If you've already run `import-old-site.js` then you can run it on the resulting `ExtractedImage`s, turning them into full `Image`s.

**How to run it:**

`node utils/upgrade-extracted.js SOURCE`

Where `SOURCE` is the name of a source, like "`bm`".

**How does it work:**

Un-upgraded `ExtractedImage` records are found for a given source. For each record an appropriate `Artist` record match attempts to be found. As with the case of `merge-bios.js` and `map-artist-slugs.js`, if no direct match for the artist is found then the user is prompted for input to locate the correct artist.

### `utils/unmatched-artists.js`

**What does this do:** Looks for images that don't have any artist record associated with them.

**When is it used:** After some, or all, extracted images have been upgraded to full image records.

NOTE: There should probably be another script which actually attempts to search for the artist names and see if any new artist records have come in which would now match the image.

### `utils/dump-artist-json.js`

Export JSON data for testing/examining the artist data.